<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>mysql开发技巧|ArtistLu Blog </title>
	<meta name="keywords" content="mysql,GitBlog,GitBlog,博客,Markdown博客,jockchou">
	<meta name="description" content="在开发过程中，经常会遇到mysql处理一些数据，在此介绍一些关于其技巧。">
	<link rel="stylesheet" href="/theme/cube/css/font-awesome.min.css?ver=2.2">
	<link rel="stylesheet" href="/theme/cube/css/style.css?ver=2.2">
	<link rel="stylesheet" href="/theme/cube/css/style-mobile.css?ver=2.2">
	<link rel="stylesheet" href="/theme/cube/css/main.css?ver=2.2">
	<link rel="alternate" type="application/rss+xml" title="ArtistLu Blog" href="/feed.xml" />
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600,700,900" rel="stylesheet" type="text/css">
    
	</head>
<body>
	<div class="container">
	<span class="content-title">mysql开发技巧</span>
	<div class="content">
		<article class="full">
			<div class="read">
				<div class="post">
					<h2>mysql开发技巧</h2>
					<p>
					<!--
author: zhanglu
head: /blog/img/mysql001.png
date: 2017-04-26
title: mysql开发技巧
tags: mysql
images: /blog/img/mysql001.png
category: GitBlog
status: publish
summary:在开发过程中，经常会遇到mysql处理一些数据，在此介绍一些关于其技巧。
-->
<h1>mysql开发技巧</h1>
<p>通过<code>imooc</code>视频学习笔记整理如下：</p>
<h2><a name='top'></h2>
<ul>
<li><a href="#skill-one"><strong>技巧一</strong> <mark>取每个用户最大记录</mark></a></li>
<li><a href="#skill-two"><strong>技巧二</strong> <mark>取每个用户前n条记录</mark></a></li>
</ul>
<h2><a name='skill-one'></a>技巧一 <a href="#top"><em>top</em></a></h2>
<p><strong>要求：</strong>有用户表<code>users</code>和用户打怪表 <code>user_kill</code>如下， 查出所有用户对于某天打怪最多记录数.</p>
<pre><code>table：users
+----+-----------+
| id | name      |
+----+-----------+
|  1 | 唐僧       |
|  2 | 孙悟空     |
|  3 | 猪八戒     |
|  4 | 沙僧       |
+----+-----------+</code></pre>
<pre><code>table：user_kill
+---------+---------------------+-------+
| user_id | created_at          | kills |
+---------+---------------------+-------+
|       1 | 2017-04-21 00:00:00 |     3 |
|       2 | 2017-04-21 00:00:00 |     9 |
|       3 | 2017-04-21 00:00:00 |     2 |
|       4 | 2017-04-21 00:00:00 |     1 |
|       1 | 2017-04-22 00:00:00 |     5 |
|       2 | 2017-04-22 00:00:00 |     7 |
|       3 | 2017-04-22 00:00:00 |     6 |
|       4 | 2017-04-22 00:00:00 |     9 |
|       1 | 2017-04-23 00:00:00 |     3 |
|       2 | 2017-04-23 00:00:00 |     1 |
|       3 | 2017-04-23 00:00:00 |     3 |
|       4 | 2017-04-23 00:00:00 |     7 |
|       1 | 2017-04-24 00:00:00 |     9 |
|       2 | 2017-04-24 00:00:00 |     3 |
|       3 | 2017-04-24 00:00:00 |     6 |
|       4 | 2017-04-24 00:00:00 |     2 |
+---------+---------------------+-------+</code></pre>
<h3>方法一</h3>
<p><strong>step1</strong>连接两表</p>
<pre><code class="language-sql">SELECT a.name, created_at, kills
FROM users a
    JOIN user_kill b ON a.id = b.user_id;</code></pre>
<pre><code>+-----------+---------------------+-------+
| name      | created_at          | kills |
+-----------+---------------------+-------+
| 唐僧      | 2017-04-21 00:00:00 |     3 |
| 孙悟空    | 2017-04-21 00:00:00 |     9 |
| 猪八戒    | 2017-04-21 00:00:00 |     2 |
| 沙僧      | 2017-04-21 00:00:00 |     1 |
| 唐僧      | 2017-04-22 00:00:00 |     5 |
| 孙悟空    | 2017-04-22 00:00:00 |     7 |
| 猪八戒    | 2017-04-22 00:00:00 |     6 |
| 沙僧      | 2017-04-22 00:00:00 |     9 |
| 唐僧      | 2017-04-23 00:00:00 |     3 |
| 孙悟空    | 2017-04-23 00:00:00 |     1 |
| 猪八戒    | 2017-04-23 00:00:00 |     3 |
| 沙僧      | 2017-04-23 00:00:00 |     7 |
| 唐僧      | 2017-04-24 00:00:00 |     9 |
| 孙悟空    | 2017-04-24 00:00:00 |     3 |
| 猪八戒    | 2017-04-24 00:00:00 |     6 |
| 沙僧      | 2017-04-24 00:00:00 |     2 |
+-----------+---------------------+-------+
</code></pre>
<p><strong><em>step2</em></strong> 再次链接user_kill <code>group by</code> <code>max()</code> <code>hving</code></p>
<pre><code class="language-sql">SELECT name, b.created_at, b.kills, MAX(c.kills) AS max_kills
FROM users a
    JOIN user_kill b ON a.id = b.user_id
    JOIN user_kill c ON b.user_id = c.user_id
GROUP BY name, b.created_at, b.kills
HAVING b.kills = max_kills</code></pre>
<pre><code>+-----------+---------------------+-------+-----------+
| name      | created_at          | kills | max_kills |
+-----------+---------------------+-------+-----------+
| 唐僧      | 2017-04-24 00:00:00 |     9 |         9 |
| 孙悟空    | 2017-04-21 00:00:00 |     9 |         9 |
| 沙僧      | 2017-04-22 00:00:00 |     9 |         9 |
| 猪八戒    | 2017-04-22 00:00:00 |     6 |         6 |
| 猪八戒    | 2017-04-24 00:00:00 |     6 |         6 |
+-----------+---------------------+-------+-----------+</code></pre>
<p><strong><mark>注意</mark>：</strong>为了便于理解结果有很多多余字段，在工作当中可以省略掉不必要的字段和数据</p>
<h3>方法二</h3>
<p><strong>step1</strong> 先查出某人的最高打怪记录数</p>
<pre><code class="language-sql">SELECT user_id, MAX(kills) AS max_kills
FROM user_kill
GROUP BY user_id</code></pre>
<pre><code>+---------+-----------+
| user_id | max_kills |
+---------+-----------+
|       1 |         9 |
|       2 |         9 |
|       3 |         6 |
|       4 |         9 |
+---------+-----------+</code></pre>
<p><strong>step2</strong> 查出打怪记录</p>
<pre><code class="language-sql">SELECT name, user_id, created_at, kills
FROM users a
    JOIN user_kill b ON a.id = b.user_id</code></pre>
<pre><code>+-----------+---------+---------------------+-------+
| name      | user_id | created_at          | kills |
+-----------+---------+---------------------+-------+
| 唐僧      |       1 | 2017-04-21 00:00:00 |     3 |
| 孙悟空    |       2 | 2017-04-21 00:00:00 |     9 |
| 猪八戒    |       3 | 2017-04-21 00:00:00 |     2 |
| 沙僧      |       4 | 2017-04-21 00:00:00 |     1 |
| 唐僧      |       1 | 2017-04-22 00:00:00 |     5 |
| 孙悟空    |       2 | 2017-04-22 00:00:00 |     7 |
| 猪八戒    |       3 | 2017-04-22 00:00:00 |     6 |
| 沙僧      |       4 | 2017-04-22 00:00:00 |     9 |
| 唐僧      |       1 | 2017-04-23 00:00:00 |     3 |
| 孙悟空    |       2 | 2017-04-23 00:00:00 |     1 |
| 猪八戒    |       3 | 2017-04-23 00:00:00 |     3 |
| 沙僧      |       4 | 2017-04-23 00:00:00 |     7 |
| 唐僧      |       1 | 2017-04-24 00:00:00 |     9 |
| 孙悟空    |       2 | 2017-04-24 00:00:00 |     3 |
| 猪八戒    |       3 | 2017-04-24 00:00:00 |     6 |
| 沙僧      |       4 | 2017-04-24 00:00:00 |     2 |
+-----------+---------+---------------------+-------+</code></pre>
<p><strong>step3</strong> <code>in()</code>多字段过滤</p>
<pre><code class="language-sql">SELECT name, user_id, created_at, kills
FROM users a
    JOIN user_kill b ON a.id = b.user_id
WHERE (user_id, kills) IN (SELECT user_id, MAX(kills) AS max_kills
    FROM user_kill
    GROUP BY user_id)</code></pre>
<pre><code>+-----------+---------+---------------------+-------+
| name      | user_id | created_at          | kills |
+-----------+---------+---------------------+-------+
| 孙悟空    |       2 | 2017-04-21 00:00:00 |     9 |
| 猪八戒    |       3 | 2017-04-22 00:00:00 |     6 |
| 沙僧      |       4 | 2017-04-22 00:00:00 |     9 |
| 唐僧      |       1 | 2017-04-24 00:00:00 |     9 |
| 猪八戒    |       3 | 2017-04-24 00:00:00 |     6 |
+-----------+---------+---------------------+-------+</code></pre>
<h3>方法三</h3>
<p>连表查询，较方法二高效，方法二更易于理解.</p>
<pre><code class="language-sql">SELECT name, b.user_id, created_at, b.kills, c.max_kills
FROM users a
    JOIN user_kill b ON a.id = b.user_id
    JOIN (SELECT user_id, MAX(kills) AS max_kills
        FROM user_kill
        GROUP BY user_id
        ) c ON b.user_id = c.user_id
WHERE b.kills = c.max_kills</code></pre>
<pre><code>+-----------+---------+---------------------+-------+-----------+
| name      | user_id | created_at          | kills | max_kills |
+-----------+---------+---------------------+-------+-----------+
| 孙悟空    |       2 | 2017-04-21 00:00:00 |     9 |         9 |
| 猪八戒    |       3 | 2017-04-22 00:00:00 |     6 |         6 |
| 沙僧      |       4 | 2017-04-22 00:00:00 |     9 |         9 |
| 唐僧      |       1 | 2017-04-24 00:00:00 |     9 |         9 |
| 猪八戒    |       3 | 2017-04-24 00:00:00 |     6 |         6 |
+-----------+---------+---------------------+-------+-----------+</code></pre>
<h2><a name='skill-two'></a>技巧二 <a href="#top"><em>top</em></a></h2>
<p><strong>要求</strong> 查询每个用户打怪数排前<strong>n</strong>名记录</p>
<p><strong>step1</strong> <code>users</code> 两次连表 <code>user_kill</code> 第二次用 <code>cross join</code></p>
<pre><code class="language-sql">SELECT name, b.created_at, b.kills, c.kills
FROM users a
    JOIN user_kill b ON a.id = b.user_id
    CROSS JOIN user_kill c ON b.user_id = c.user_id
        AND b.kills &lt; c.kills</code></pre>
<pre><code>+-----------+---------------------+-------+-------+
| name      | created_at          | kills | kills |
+-----------+---------------------+-------+-------+
| 孙悟空    | 2017-04-22 00:00:00 |     7 |     9 |
| 孙悟空    | 2017-04-23 00:00:00 |     1 |     9 |
| 孙悟空    | 2017-04-24 00:00:00 |     3 |     9 |
| 唐僧      | 2017-04-21 00:00:00 |     3 |     5 |
| 唐僧      | 2017-04-23 00:00:00 |     3 |     5 |
| 孙悟空    | 2017-04-23 00:00:00 |     1 |     7 |
| 孙悟空    | 2017-04-24 00:00:00 |     3 |     7 |
| 猪八戒    | 2017-04-21 00:00:00 |     2 |     6 |
| 猪八戒    | 2017-04-23 00:00:00 |     3 |     6 |
| 沙僧      | 2017-04-21 00:00:00 |     1 |     9 |
| 沙僧      | 2017-04-23 00:00:00 |     7 |     9 |
| 沙僧      | 2017-04-24 00:00:00 |     2 |     9 |
| 猪八戒    | 2017-04-21 00:00:00 |     2 |     3 |
| 沙僧      | 2017-04-21 00:00:00 |     1 |     7 |
| 沙僧      | 2017-04-24 00:00:00 |     2 |     7 |
| 唐僧      | 2017-04-21 00:00:00 |     3 |     9 |
| 唐僧      | 2017-04-22 00:00:00 |     5 |     9 |
| 唐僧      | 2017-04-23 00:00:00 |     3 |     9 |
| 孙悟空    | 2017-04-23 00:00:00 |     1 |     3 |
| 猪八戒    | 2017-04-21 00:00:00 |     2 |     6 |
| 猪八戒    | 2017-04-23 00:00:00 |     3 |     6 |
| 沙僧      | 2017-04-21 00:00:00 |     1 |     2 |
+-----------+---------------------+-------+-------+</code></pre>
<p><strong>step2</strong> 通过 <code>group by name,b.created_at,b.kills</code> 比较两次 <code>user_kill</code>表得出每个人打怪排名.</p>
<pre><code class="language-sql">SELECT name, b.created_at, b.kills, (
        SELECT COUNT(*) + 1
        FROM user_kill c
        WHERE c.user_id = b.user_id
            AND c.kills &gt; b.kills
        ) AS rank
FROM users a
    JOIN user_kill b ON a.id = b.user_id

HAVING rank &lt;= 2
ORDER BY name</code></pre>
<pre><code>+-----------+---------------------+-------+------+
| name      | created_at          | kills | rank |
+-----------+---------------------+-------+------+
| 唐僧      | 2017-04-22 00:00:00 |     5 |    2 |
| 唐僧      | 2017-04-24 00:00:00 |     9 |    1 |
| 孙悟空    | 2017-04-21 00:00:00 |     9 |    1 |
| 孙悟空    | 2017-04-22 00:00:00 |     7 |    2 |
| 沙僧      | 2017-04-22 00:00:00 |     9 |    1 |
| 沙僧      | 2017-04-23 00:00:00 |     7 |    2 |
| 猪八戒    | 2017-04-24 00:00:00 |     6 |    1 |
| 猪八戒    | 2017-04-22 00:00:00 |     6 |    1 |
+-----------+---------------------+-------+------+</code></pre>
<p><strong><mark>注意<mark></strong> 如果打怪数有重复，此查询有一定缺陷.</p>
					</p>
				</div>
				<div class="meta">
					<span>2017-04-26 zhanglu</span>
				</div>
			</div>
		</article>
			</div>
	<div id="	comment
	"></div>
</div>

<footer class="footer">
    <div class="footer_bottom">
        <div class="follow-us">
            <a class="fa fa-github social-icon" href="https://github.com/artistlu"></a>
            <a class="fa fa-weibo social-icon" href="http://weibo.com/"></a>
        </div>

        <div class="copy">
            <p>Copyright &copy; 2015 Gitblog | Proudly powered by <a href="http://www.gitblog.cn/">Gitblog</a>.</p>
        </div>
    </div>
</footer>

<a title="首页" class="fa fa-paper-plane dp-dropplets-icon" href="/"></a>

<link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/8.6/styles/github.min.css">
<script src="//cdn.bootcss.com/highlight.js/8.6/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
